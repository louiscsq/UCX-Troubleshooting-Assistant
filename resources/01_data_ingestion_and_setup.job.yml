resources:
  jobs:
    w01_data_ingestion_and_setup:
      name: w01_${var.project_prefix}_data_ingestion_and_setup
      queue:
        enabled: true

      parameters:
        - name: "config_file"
          default: "${var.config_file}"
        - name: "repo"
          default: "${var.repo}"
        - name: "summarising_endpoint"
          default: "${var.summarising_endpoint}"
        - name: "table_codebase"
          default: "${var.table_codebase}"
        - name: "table_documentation"
          default: "${var.table_documentation}"
        - name: "table_internal_documents"
          default: "${var.table_internal_documents}"
        - name: "catalog_name"
          default: "${var.catalog_name}"
        - name: "schema_name"
          default: "${var.schema_name}"
        - name: "schema"
          default: "${var.schema}"
        - name: "volume_name"
          default: "${var.volume_name}"
        - name: "internal_documents_volume_path"
          default: "/Volumes/${var.catalog_name}/${var.schema_name}/${var.volume_name}"
        - name: "workspace_documents_path"
          default: "/Workspace/Shared/${var.project_prefix}"
        - name: "github_token"
          default: ""
        - name: "vector_search_endpoint"
          default: "${var.vector_search_endpoint}"

      tasks:
        - task_key: setup_volume
          notebook_task:
            notebook_path: "../01_data_ingestion_and_setup/setup_volume_and_pdf.py"

        - task_key: ingest_documentation
          notebook_task:
            notebook_path: "../01_data_ingestion_and_setup/ingest_documentation.py"
          environment_key: env2

        - task_key: ingest_internal_documents
          notebook_task:
            notebook_path: "../01_data_ingestion_and_setup/ingest_internal_documents.py"
          depends_on:
            - task_key: setup_volume

        - task_key: ingest_codebase
          notebook_task:
            notebook_path: "../01_data_ingestion_and_setup/ingest_codebase.py"
          environment_key: env2

        - task_key: create_vector_codebase
          notebook_task:
            notebook_path: "../01_data_ingestion_and_setup/create_vector.py"
            base_parameters:
              table_source: "${var.table_codebase}"
          depends_on:
            - task_key: ingest_codebase
            - task_key: ingest_documentation
            - task_key: ingest_internal_documents
        
        - task_key: create_vector_documentation
          notebook_task:
            notebook_path: "../01_data_ingestion_and_setup/create_vector.py"
            base_parameters:
              table_source: "${var.table_documentation}"
          depends_on:
            - task_key: create_vector_codebase
        
        - task_key: create_vector_internal_documents
          notebook_task:
            notebook_path: "../01_data_ingestion_and_setup/create_vector.py"
            base_parameters:
              table_source: "${var.table_internal_documents}"
          depends_on:
            - task_key: create_vector_codebase
          
      environments:
      - environment_key: env2
        spec:
          environment_version: "2"